<?php

/**
 * @file
 * Functions to support theming in the IBEW theme.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_preprocess_HOOK() for html templates.
 */
function ibew_theme_preprocess_html(&$variables) {
  // Add path-based body classes for CSS targeting
  $current_path = \Drupal::service('path.current')->getPath();
  $path_alias = \Drupal::service('path_alias.manager')->getAliasByPath($current_path);
  
  // Convert path to CSS-safe class name
  $path_class = \Drupal\Component\Utility\Html::getClass($current_path);
  $variables['attributes']['class'][] = $path_class;
  
  // Add specific class for user pages
  if (str_starts_with($current_path, '/user')) {
    $variables['attributes']['class'][] = 'path-user';
  }

  // Add specific class for contact page
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'ibew_contact.contact_page') {
    $variables['attributes']['class'][] = 'path-contact';
  }

  // --- Inject Color Scheme CSS Variables ---
  // Retrieve Light Mode Settings
  $light_primary = theme_get_setting('ibew_light_primary') ?? '#1e293b';
  $light_secondary = theme_get_setting('ibew_light_secondary') ?? '#3b82f6';
  $light_accent = theme_get_setting('ibew_light_accent') ?? '#f59e0b';
  $light_bg = theme_get_setting('ibew_light_bg') ?? '#ffffff';
  $light_card_bg = theme_get_setting('ibew_light_card_bg') ?? '#f3f4f6';
  $light_text = theme_get_setting('ibew_light_text') ?? '#1f2937';

  // Retrieve Dark Mode Settings
  $dark_primary = theme_get_setting('ibew_dark_primary') ?? '#1e293b';
  $dark_secondary = theme_get_setting('ibew_dark_secondary') ?? '#3b82f6';
  $dark_accent = theme_get_setting('ibew_dark_accent') ?? '#f59e0b';
  $dark_bg = theme_get_setting('ibew_dark_bg') ?? '#1f2937';
  $dark_card_bg = theme_get_setting('ibew_dark_card_bg') ?? '#3e4c63';
  $dark_text = theme_get_setting('ibew_dark_text') ?? '#f3f4f6';

  // Build the inline CSS
  $custom_css = "
    /* LIGHT MODE (Default) */
    :root {
      --ibew-primary: {$light_primary} !important;
      --ibew-secondary: {$light_secondary} !important;
      --ibew-accent: {$light_accent} !important;
      --ibew-accent-hover: {$light_accent} !important;
      --ibew-bg-light: {$light_bg} !important; /* Maps to body bg in light mode */
      --ibew-text-dark: {$light_text} !important;
      --ibew-card-bg: {$light_card_bg} !important;
    }
    
    body {
        background-color: var(--ibew-bg-light) !important;
        color: var(--ibew-text-dark) !important;
    }

    /* Apply Light Mode Card Background */
    body:not(.dark) .ibew-card-surface,
    body:not(.dark) .ibew-event-card,
    body:not(.dark) .fc {
        background-color: var(--ibew-card-bg) !important;
    }

    /* DARK MODE OVERRIDES */
    html.dark {
      --ibew-primary: {$dark_primary} !important;
      --ibew-secondary: {$dark_secondary} !important;
      --ibew-accent: {$dark_accent} !important;
      --ibew-accent-hover: {$dark_accent} !important;
      --ibew-bg-light: {$dark_bg} !important; /* Maps to body bg in dark mode */
      --ibew-text-dark: {$dark_text} !important;
      --ibew-card-bg: {$dark_card_bg} !important;
    }

    /* Ensure Dark Mode variables apply when class is present */
    html.dark body {
        background-color: var(--ibew-bg-light) !important;
        color: var(--ibew-text-dark) !important;
    }

    html.dark .ibew-card-surface,
    html.dark .ibew-event-card, 
    html.dark .fc { 
       background-color: var(--ibew-card-bg) !important;
    }
  ";

  // Attach as an html_head element
  $variables['page']['#attached']['html_head'][] = [
    [
      '#tag' => 'style',
      '#value' => $custom_css,
    ],
    'ibew-theme-colors'
  ];
}

/**
 * Implements hook_preprocess_HOOK() for page templates.
 */
function ibew_theme_preprocess_page(&$variables) {
  // Add custom variables or logic here
  // Only attach global styling if we are NOT on an admin route.
  if (!\Drupal::service('router.admin_context')->isAdminRoute()) {
    $variables['#attached']['library'][] = 'ibew_theme/global-styling';
  }

  // Attach login page styling on user routes
  $current_path = \Drupal::service('path.current')->getPath();
  if (str_starts_with($current_path, '/user')) {
    $variables['#attached']['library'][] = 'ibew_theme/login-page';
  }

  // Attach contact page styling
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'ibew_contact.contact_page') {
    $variables['#attached']['library'][] = 'ibew_theme/contact-page';
  }

  // Manually embed Views to guarantee placement and bypass ghost blocks
  $variables['embedded_news_view'] = views_embed_view('homepage_news', 'block_1');
  $variables['embedded_events_view'] = views_embed_view('homepage_events', 'block_1');

  // Ensure logo availability
  $logo_url = theme_get_setting('logo.url');
  if ($logo_url) {
    $variables['logo'] = $logo_url;
  }

  // Pass Theme Settings to Template with Defaults
  $variables['top_bar_show'] = theme_get_setting('top_bar_show') ?? TRUE;
  $variables['top_bar_address'] = theme_get_setting('top_bar_address') ?: '2 N Plains Industrial Rd, Wallingford, CT 06492';
  $variables['top_bar_phone'] = theme_get_setting('top_bar_phone') ?: '1-800-562-2590';
  $variables['top_bar_email'] = theme_get_setting('top_bar_email') ?: 'info@ibewlocal90.org';
  $variables['top_bar_join_link'] = theme_get_setting('top_bar_join_link') ?: 'https://JoinIBEWCT.org';
  $variables['top_bar_join_text'] = theme_get_setting('top_bar_join_text') ?: 'JoinIBEWCT.org';
  
  // Default social links to '#' so icons render by default (mimicking hardcoded behavior)
  $variables['social_facebook'] = theme_get_setting('social_facebook') ?: '#';
  $variables['social_twitter'] = theme_get_setting('social_twitter') ?: '#';
  $variables['social_linkedin'] = theme_get_setting('social_linkedin') ?: '#';
  $variables['social_instagram'] = theme_get_setting('social_instagram') ?: '#';

  // LOAD MAIN MENU PROGRAMMATICALLY (Global Navigation)
  // This ensures the menu is available on EVERY page, regardless of block layout.
  $menu_tree = \Drupal::menuTree();
  // Use generic parameters to load the full menu tree, not just the active trail.
  // This fixes issues where pages not in the menu (like specific news articles) show an empty/fallback menu.
  $parameters = new \Drupal\Core\Menu\MenuTreeParameters();
  $parameters->onlyEnabledLinks(); // Only show enabled links
  $tree = $menu_tree->load('main', $parameters);
  $manipulators = [
    ['callable' => 'menu.default_tree_manipulators:checkAccess'],
    ['callable' => 'menu.default_tree_manipulators:generateIndexAndSort'],
  ];
  $tree = $menu_tree->transform($tree, $manipulators);
  
  // Desktop Menu
  $variables['ibew_main_menu'] = $menu_tree->build($tree);
  
  // Mobile Menu (Same links, different template)
  $mobile_menu_build = $menu_tree->build($tree);
  $mobile_menu_build['#theme'] = 'menu__mobile';
  $variables['ibew_mobile_menu'] = $mobile_menu_build;

  // FORCE INJECT HERO SLIDER (Direct Render Strategy)
  // Load the Block Content (ID 40) that the user is editing.
  $hero_block = \Drupal\block_content\Entity\BlockContent::load(40);
  if ($hero_block) {
    $slides_data = [];
    
    // Check fields and iterate
    if ($hero_block->hasField('field_hero_slides') && !$hero_block->get('field_hero_slides')->isEmpty()) {
       $slides = $hero_block->get('field_hero_slides')->referencedEntities();
       foreach ($slides as $slide) {
         if ($slide->hasField('field_hero_media') && !$slide->get('field_hero_media')->isEmpty()) {
           $media = $slide->get('field_hero_media')->entity;
           if ($media && $media->hasField('field_media_image') && !$media->get('field_media_image')->isEmpty()) {
             $file = $media->get('field_media_image')->entity;
             if ($file) {
               $url = \Drupal::service('file_url_generator')->generateAbsoluteString($file->getFileUri());
               $slides_data[] = ['url' => $url];
             }
           }
         }
       }
    }
    
    $script_markup = '<script>
      document.addEventListener("DOMContentLoaded", function () {
        if (document.querySelector("#ibewHeroSplide")) {
          new Splide("#ibewHeroSplide", {
            type: "fade",
            rewind: true,
            autoplay: true,
            interval: 5000,
            arrows: true,
            pagination: true,
            cover: true,
            height: "100%",
          }).mount();
        }
      });
    </script>';

    $variables['page']['homepage_hero'] = [
      'slider' => [
        '#theme' => 'ibew_hero_slider',
        '#slides' => $slides_data,
      ],
      'script' => [
        '#markup' => $script_markup,
        '#allowed_tags' => ['script'],
      ],
    ];
  }
}


/**
 * Implements hook_form_alter().
 */
function ibew_theme_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Add custom form alterations here
}

/**
 * Implements hook_theme_suggestions_HOOK_alter() for page templates.
 */
function ibew_theme_theme_suggestions_page_alter(array &$suggestions, array $variables) {
  // Add custom page suggestions based on path alias
  $path = \Drupal::service('path.current')->getPath();
  $alias = \Drupal::service('path_alias.manager')->getAliasByPath($path);
  
  if ($alias == '/events') {
    $suggestions[] = 'page__events';
  }
  if ($alias == '/join') {
    $suggestions[] = 'page__join';
  }

  // Add template suggestion for contact page route
  $route_name = \Drupal::routeMatch()->getRouteName();
  if ($route_name === 'ibew_contact.contact_page') {
    $suggestions[] = 'page__contact';
  }
}

/**
 * Implements hook_theme_suggestions_HOOK_alter() for html templates.
 */
function ibew_theme_theme_suggestions_html_alter(array &$suggestions, array $variables) {
  // Add custom html template for login page
  $route_name = \Drupal::routeMatch()->getRouteName();
  
  if ($route_name === 'user.login') {
    $suggestions[] = 'html__user__login';
  }
  if ($route_name === 'user.register') {
    $suggestions[] = 'html__user__register';
  }
  if ($route_name === 'user.pass') {
    $suggestions[] = 'html__user__password';
  }
}

/**
 * Implements hook_preprocess_block().
 *
 * Adds front-page styling classes to blocks placed in the homepage regions so
 * they inherit the card styling from the theme's CSS.
 */
function ibew_theme_preprocess_block(array &$variables) {
  // Avoid adding card styles to the main page content block prevent layout issues.
  if (isset($variables['plugin_id']) && $variables['plugin_id'] === 'system_main_block') {
    return;
  }
  
  // Also avoid adding card styles to homepage structural blocks, as they often contain their own grids.
  // We only want these classes on "widget" style blocks (like sidebars).
  $homepage_regions = [
    'header',
    'homepage_hero',
    'homepage_hero_content',
    'homepage_about',
    'homepage_news',
    'homepage_events',
    'homepage_members',
    'homepage_contact',
    'footer'
  ];

  // If we are on the front page, treats 'content' region as a homepage region too
  // to prevent standard blocks placed there from getting boxed.
  $is_front = \Drupal::service('path.matcher')->isFrontPage();
  if ($is_front) {
      $homepage_regions[] = 'content';
  }

  if (isset($variables['elements']['#id'])) {
      $block = \Drupal\block\Entity\Block::load($variables['elements']['#id']);
      if ($block && in_array($block->getRegion(), $homepage_regions)) {
          return;
      }
  }

  // Safely add classes ensuring attributes is an object.
  if (isset($variables['attributes']) && $variables['attributes'] instanceof \Drupal\Core\Template\Attribute) {
    // Only add card styling if NOT in excluded regions (logic handled above)
    $variables['attributes']->addClass(['ibew-card', 'ibew-ghost-border']);
  }
  elseif (isset($variables['attributes']) && is_array($variables['attributes'])) {
    if (empty($variables['attributes']['class'])) {
      $variables['attributes']['class'] = [];
    }
    $variables['attributes']['class'][] = 'ibew-card';
    $variables['attributes']['class'][] = 'ibew-ghost-border';
  }
}

/**
 * Implements hook_preprocess_region().
 *
 * Adds layout helper classes to homepage regions so placed blocks inherit grid
 * spacing similar to the design in the Twig template fallbacks.
 */
function ibew_theme_preprocess_region(array &$variables) {
  $layout_classes = [
    'homepage_contact' => ['ibew-row'],
  ];

          // Manual Block Reordering in Homepage Regions
          // To ensure "Welcome" blocks come BEFORE "About" blocks
          // We include 'homepage_hero_content' in case blocks are placed there.
          if ($variables['region'] === 'homepage_about' || $variables['region'] === 'content' || $variables['region'] === 'homepage_hero_content') {
              if (isset($variables['elements']) && is_array($variables['elements'])) {
                  $needs_sort = false;

                  // Find the blocks
                  foreach (\Drupal\Core\Render\Element::children($variables['elements']) as $key) {
                      $element = $variables['elements'][$key];
                      
                      // CLEANUP: aggressive fix for "broken or missing" block errors
                      // If a block is "broken", it often has a specific plugin ID.
                      $is_broken = false;
                      if (isset($element['#plugin_id']) && (
                          $element['#plugin_id'] === 'broken' || 
                          strpos($element['#plugin_id'], 'broken') !== false ||
                          strpos($element['#plugin_id'], 'missing') !== false
                      )) {
                          $is_broken = true;
                      }

                      // Also check if the #block content entity is null (common cause of OOB exception)
                      if (isset($element['#id']) && !isset($element['content']['#block_content'])) {
                           // This is harder to detect safely without loading entities, which we want to avoid in preprocess if possible.
                           // But often broken blocks render just a message.
                      }

                      if ($is_broken) {
                          unset($variables['elements'][$key]);
                          continue; 
                      }

                      if (isset($element['#configuration']['label'])) {
                          $label = $element['#configuration']['label'];
                          
                          // Force "Welcome" / "Intro" blocks to the top
                          if (stripos($label, 'Welcome') !== false || stripos($label, 'Intro') !== false) {
                              $variables['elements'][$key]['#weight'] = -1000;
                              $needs_sort = true;
                          }
                          // Force "About" / "History" blocks to the bottom
                          elseif (stripos($label, 'About') !== false || stripos($label, 'History') !== false) {
                              $variables['elements'][$key]['#weight'] = 1000;
                              $needs_sort = true;
                          }
                      }
                  }

                  // Resort if weights were changed
                  if ($needs_sort) {
                       uasort($variables['elements'], ['\Drupal\Component\Utility\SortArray', 'sortByWeightProperty']);
                  }
              }
          }

  if (!isset($layout_classes[$variables['region']])) {
    return;
  }

  // Safely add classes ensuring attributes is an object.
  if (isset($variables['attributes']) && $variables['attributes'] instanceof \Drupal\Core\Template\Attribute) {
    $variables['attributes']->addClass($layout_classes[$variables['region']]);
  }
  elseif (isset($variables['attributes']) && is_array($variables['attributes'])) {
    if (empty($variables['attributes']['class'])) {
      $variables['attributes']['class'] = [];
    }
    foreach ($layout_classes[$variables['region']] as $class) {
      $variables['attributes']['class'][] = $class;
    }
  }
}

/**
 * Implements hook_preprocess_paragraph().
 */
function ibew_theme_preprocess_paragraph(&$variables) {
  $paragraph = $variables['paragraph'];
  $bundle = $paragraph->bundle();

  if ($bundle == 'ibew_section_news_events') {
    $variables['embedded_news_view'] = views_embed_view('homepage_news', 'block_1');
    $variables['embedded_events_view'] = views_embed_view('homepage_events', 'block_1');
  }
  elseif ($bundle == 'ibew_section_news') {
    $variables['embedded_news_view'] = views_embed_view('homepage_news', 'block_1');
  }
  elseif ($bundle == 'ibew_section_events') {
    $variables['embedded_events_view'] = views_embed_view('homepage_events', 'block_1');
  }
}
